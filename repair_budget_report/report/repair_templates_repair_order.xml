<?xml version="1.0" encoding="utf-8"?>
<odoo>
<template id="repair_budget_report" inherit_id="repair.report_repairorder">
        <t t-set="o" t-value="doc"/>
        <xpath expr="//t[@t-call='web.external_layout']" position="replace">
            <t t-call="web.external_layout">
                <t t-set="o" t-value="o.with_context(lang=o.partner_id.lang)" />
                <t t-foreach="docs" t-as="doc">
                    <style>
                        *{
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                            text-transform: uppercase;
                        }
                        .shipping{
                            width: 29,5%;
                            border: thin solid black;
                            padding: 10px;
                        }
                        .shipping &gt; span{
                            font-size: 11px;
                        }
                        .address{
                            width: 49,5%;
                            border: thin solid black;
                            padding: 10px;
                            vertical-align: middle;
                        }
                        .address span{
                            font-size: 12px;
                        }
                    </style>    
                </t>
                <div class="page">
                    <table>
                        <td class="shipping">
                            <span>
                                <h3>ORÇAMENTO Nº: <span t-field="doc.id"/>
                                </h3>
                            </span>
                            <br/>
                            <h6>
                                <span>CNPJ: <span t-field="doc.company_id.cnpj_cpf"/>
                                </span>
                            </h6>
                            <h6>
                                <span>Insc. Estadual: <span t-field="doc.company_id.inscr_est"/>
                                </span>
                            </h6>
                            <br/>
                            <span>
                                <h4>DATA DE EMISSÃO : <span t-field="doc.date_repair"/>
                                </h4>
                            </span>
                        </td>
                        <td style="width: 0,5%"/>
                        <td class="address">
                                <h4 t-field="doc.company_id.name"/>
                                <br/>
                                <span t-field="doc.company_id.street_name"/>, <span t-field="doc.company_id.street_number"/> - <span t-field="doc.company_id.district"/><br/>
                                
                                <span>CEP: <span t-field="doc.company_id.zip"/> - <span t-field="doc.company_id.city_id"/> - <span t-field="doc.company_id.state_id.code"/></span><br/>
                                <br/>
                                <span>FONES: <span t-field="doc.company_id.phone"/></span><br/>
                                <br/>
                        </td>
                    </table>
                    <div class="oe_structure"/>
                    <h2>
                        <span t-if="o.state != 'draft'">Repair Order #:</span>
                        <span t-if="o.state == 'draft'">Orçamento de Serviços #:</span>
                        <span t-field="o.name"/>
                    </h2>

                    <div id="informations" class="row mt32 mb32">
                        <div t-if="o.product_id.name" class="col-3 bm-2">
                            <strong>Produto a Reparar:</strong>
                            <p t-field="o.product_id.name" class="m-0"/>
                        </div>
                        <div class="col-3 bm-2" groups="stock.group_production_lot">
                            <strong>Lote/Numero de Série:</strong>
                            <t t-if="o.lot_id">
                                <span t-field="o.lot_id.name"/>
                            </t>
                        </div>
                        <div t-if="o.date_repair" class="col-3 bm-2">
                            <strong>Emissao:</strong>
                            <p t-field="o.date_repair" class="m-0"/>
                        </div>
                        <div class="col-3 bm-2">
                            <strong>Validade:</strong>
                            <p t-field="o.data_validacao" class="m-0"/>
                        </div>
                        <div class="col-3 bm-2">
                            <strong>Observações:</strong>
                            <p t-field="o.quotation_notes" class="m-0"/>
                        </div>

                    </div>
                    <t t-set="tot_pecas" t-value="0.0" />
                    <t t-set="tot_servicos" t-value="0.0" />
                    <table class="table table-sm o_main_table">
                        <thead>
                            <tr>
                                <th>Descrição</th>
                                <th class="text-right">Quantidade</th>
                                <t t-if="o.invoice_method != 'none'">
                                    <th class="text-right">Preço Unitário</th>
                                    <th class="text-center">Taxa</th>
                                    <th class="text-right">Preço</th>
                                </t>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-if="o.operations">
                                <tr class="bg-200 o_line_section"><td colspan="5"><strong>Peças de reposição</strong></td></tr>
                                
                                <tr t-foreach="o.operations" t-as="line">
                                    <t t-set="tot_pecas" t-value="tot_pecas + line.price_subtotal" />
                                    <td>
                                        <span t-field="line.name" />
                                    </td>
                                    <td class="text-right">
                                        <span t-field="line.product_uom_qty"/>
                                        <span groups="uom.group_uom" t-field="line.product_uom.name"/>
                                    </td>
                                    <t t-if="(line.repair_id.invoice_method != 'none')">
                                        <td class="text-right">
                                            <span t-field="line.price_unit"/>
                                        </td>
                                        <td class="text-center">
                                            <span t-esc="','.join(map( lambda x: x.name, line.tax_id))"/>
                                        </td>
                                        <td class="text-right o_price_total">
                                            <span t-field="line.price_subtotal" t-options='{"widget": "monetary", "display_currency": o.pricelist_id.currency_id}'/>
                                       </td>
                                    </t>
                                </tr>
                            </t>
                        </tbody>
                    </table>

                    <table class="table table-sm o_main_table">
                        <thead>
                            <tr>
                                <th>Descrição</th>
                                <th class="text-right">Quantidade</th>
                                <t t-if="o.invoice_method != 'none'">
                                    <th class="text-right">Preço Unitário</th>
                                    <th class="text-center">Taxa</th>
                                    <th class="text-right">Preço</th>
                                </t>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-if="o.fees_lines">
                                <tr class="bg-200 o_line_section"><td colspan="5"><strong>Serviços</strong></td></tr>
                                <tr t-foreach="o.fees_lines" t-as="fees">
                                    <t t-set="tot_servicos" t-value="tot_servicos + fees.price_subtotal" />
                                    <td>
                                        <span t-field="fees.name"/>
                                    </td>
                                    <td class="text-right">
                                        <span t-field="fees.product_uom_qty"/>
                                        <span groups="uom.group_uom" t-field="fees.product_uom.name"/>
                                    </td>
                                    <t t-if="(fees.repair_id.invoice_method != 'none')">
                                        <td class="text-right">
                                            <span t-field="fees.price_unit"/>
                                        </td>
                                        <td class="text-center">
                                            <span t-esc="','.join(map( lambda x: x.name, fees.tax_id))"/>
                                        </td>
                                        <td class="text-right o_price_total">
                                            <span t-field="fees.price_subtotal"
                                                t-options='{"widget": "monetary", "display_currency": o.pricelist_id.currency_id}'/>
                                       </td>
                                    </t>
                                </tr>
                            </t>
                        </tbody>
                    </table>

                    <div id="total" class="row justify-content-end">
                        <div class="col-4">
                            <table class="table table-sm">
                                    <tr class="border-black o_subtotal">
                                        <td><strong>subTotal Peças</strong></td>
                                        <td class="text-right">
                                            <span t-esc="tot_pecas"
                                                t-options='{"widget": "monetary", "display_currency": o.pricelist_id.currency_id}'/>
                                        </td>
                                    </tr>
                                    <tr class="border-black o_subtotal">
                                        <td><strong>subTotal Serviços</strong></td>
                                        <td class="text-right">
                                            <span t-esc="tot_servicos"
                                                t-options='{"widget": "monetary", "display_currency": o.pricelist_id.currency_id}'/>
                                        </td>
                                    </tr>
                                    <tr class="border-black o_total">
                                        <td><strong>Total</strong></td>
                                        <td class="text-right o_price_total">
                                            <span t-esc="tot_pecas + tot_servicos"
                                                t-options='{"widget": "monetary", "display_currency": o.pricelist_id.currency_id}'/>
                                        </td>
                                    </tr>
                            </table>
                        </div>
                    </div>

                    <p t-field="o.quotation_notes"/>
                    <div class="oe_structure"/>
                </div>
            </t>
        </xpath>
</template>

<!-- <template id="report_repairorder2_budget">
    <t t-call="web.html_container">
        <t t-foreach="docs" t-as="doc">
            <t t-call="report_repair_budget.report_repairorder_budget" t-lang="doc.partner_id.lang"/>
        </t>
    </t>
</template> -->
        <!-- <record id="action_report_repair_order" model="ir.actions.report">
            <field name="name">Quotation / Order</field>
            <field name="model">report.repair.budget</field>
            <field name="report_type">qweb-pdf</field>
            <field name="report_name">report_repair_budget.report_repairorder2_budget</field>
            <field name="report_file">report_repair_budget.report_repairorder2_budget</field>
            <field name="print_report_name">(
                object.state == 'draft' and 'Repair Quotation - %s' % (object.name) or
                'Repair Order - %s' % (object.name))</field>
            <field name="binding_model_id" ref="model_repair_order"/>
            <field name="binding_type">report</field>
        </record> -->
</odoo>
